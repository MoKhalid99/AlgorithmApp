@inherits LayoutComponentBase
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Routing

<NavigationLock OnBeforeInternalNavigation="HandleNavigation" ConfirmExternalNavigation="false" />

<main>
    <InfoTransition @ref="transitionScreen" OnProceed="ResumeNavigation" />

    <button class="nav-toggle-btn" @onclick="ToggleNav">
        <i class="bi @(isNavOpen ? "bi-x-lg" : "bi-list")"></i>
    </button>

    <div class="page">
        <aside class="sidebar-glass @(isNavOpen ? "open" : "")">
            <div class="sidebar-header">
                <h3 class="fw-bold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
            </div>

            <nav class="sidebar-links">
                <a href="/" @onclick="CloseNav" class="nav-item">
                    <i class="bi bi-house-door"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <a href="/roadmaps" @onclick="CloseNav" class="nav-item">
                    <i class="bi bi-map"></i> Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©
                </a>
                <a href="/Snake" @onclick="CloseNav" class="nav-item snake-link">
                    <i class="bi bi-controller"></i> Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† ğŸ
                </a>
            </nav>
        </aside>

        <div class="content-area">
            @Body
        </div>
    </div>

    <div class="chat-fab">
        <i class="bi bi-robot"></i>
        <span class="online-indicator"></span>
    </div>
</main>

@code {
    private bool isNavOpen = false;
    private InfoTransition transitionScreen; // Ù…Ø±Ø¬Ø¹ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    private string? targetUrl; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„ÙŠÙ‡
    private bool isProgrammaticNav = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ

    private void ToggleNav() => isNavOpen = !isNavOpen;
    private void CloseNav() => isNavOpen = false;

    // Ø¯Ø§Ù„Ø© Ø§Ø¹ØªØ±Ø§Ø¶ Ø§Ù„ØªÙ†Ù‚Ù„
    private void HandleNavigation(LocationChangingContext context)
    {
        if (isProgrammaticNav)
        {
            isProgrammaticNav = false;
            return;
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ
        context.PreventNavigation();

        // Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        targetUrl = context.TargetLocation;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        transitionScreen.Show();
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    private void ResumeNavigation()
    {
        if (targetUrl is not null)
        {
            transitionScreen.Hide(); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
            isProgrammaticNav = true; // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…Ø±ÙˆØ±
            Nav.NavigateTo(targetUrl); // Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø±Ø§Ø¨Ø·
        }
    }
}
