@page "/quiz/{Language}"
@inject AlgorithmApp.Services.QuizService QuizService
@inject NavigationManager NavManager
@rendermode InteractiveServer
@using System.Timers
@implements IDisposable

<div class="quiz-container">
    <div class="stars-overlay"></div>
    
    <div class="container py-4 position-relative">
        @if (questions != null && currentIndex < questions.Count && !isFinished)
        {
            <div class="quiz-nav-info d-flex justify-content-between align-items-center mb-4">
                <div class="glass-pill">
                    <span class="text-white-50 small d-block">السؤال</span>
                    <span class="fw-bold">@(currentIndex + 1) / @questions.Count</span>
                </div>

                <div class="timer-display @(timeLeft < 10 ? "critical" : "")">
                    <div class="timer-ring"></div>
                    <span class="timer-text">@timeLeft</span>
                </div>

                <div class="glass-pill">
                    <span class="text-white-50 small d-block">السكور</span>
                    <span class="fw-bold text-warning">@(score * 10)</span>
                </div>
            </div>

            <div class="code-card-glass mb-4 animate__animated animate__fadeInUp">
                <div class="card-header-dots">
                    <div class="dots-group">
                        <span class="dot red"></span>
                        <span class="dot yellow"></span>
                        <span class="dot green"></span>
                    </div>
                    <div class="lang-title">@(Language == "CSharp" ? "C#" : Language) Console</div>
                </div>
                
                <div class="card-content p-4">
                    @if (!string.IsNullOrEmpty(questions[currentIndex].CodeSnippet))
                    {
                        <div class="code-wrapper mb-4">
                            <pre><code>@questions[currentIndex].CodeSnippet</code></pre>
                        </div>
                    }
                    <h2 class="question-title text-end">@questions[currentIndex].Text</h2>
                </div>
            </div>

            <div class="row g-3">
                @for (int i = 0; i < questions[currentIndex].Options.Count; i++)
                {
                    var opt = questions[currentIndex].Options[i];
                    int index = i;
                    char letter = (char)('A' + i);
                    string letterStr = letter.ToString();

                    string feedbackClass = "";
                    if (showFeedback)
                    {
                        if (letterStr == questions[currentIndex].CorrectAnswer)
                            feedbackClass = "correct-choice";
                        else if (letterStr == selectedLetter)
                            feedbackClass = "wrong-choice";
                        else
                            feedbackClass = "muted-choice";
                    }

                    <div class="col-md-6">
                        <button class="answer-btn @feedbackClass" @onclick="() => HandleAnswer(index)" disabled="@showFeedback">
                            <span class="letter-tag">@letter</span>
                            <span class="option-text">@opt</span>
                        </button>
                    </div>
                }
            </div>
        }
        else if (isFinished)
        {
            <div class="result-glass text-center p-5 animate__animated animate__zoomIn">
                <div class="trophy-icon mb-3">🏆</div>
                <h2 class="text-white fw-bold">تهانينا!</h2>
                <div class="final-score-circle">
                    <span class="num">@score</span>
                    <span class="total">/@questions.Count</span>
                </div>
                <p class="text-white-50 mt-3">لقد حصلت على @(score * 10) نقطة</p>
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-primary btn-lg rounded-pill shadow-lg" @onclick="Restart">إعادة التحدي</button>
                    <a href="/" class="btn btn-outline-light btn-lg rounded-pill">الرئيسية</a>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public string Language { get; set; }
    private List<Data.Question> questions;
    private int currentIndex = 0, score = 0, timeLeft = 30;
    private bool isFinished = false, showFeedback = false;
    private string selectedLetter = "";
    private Timer timer;

    protected override async Task OnInitializedAsync()
    {
        string key = Language == "CSharp" ? "C#" : Language;
        questions = await QuizService.GetRandomQuestionsAsync(key);
        StartTimer();
    }

    private void StartTimer()
    {
        StopTimer();
        timeLeft = 30;
        timer = new Timer(1000);
        timer.Elapsed += async (s, e) => {
            if (timeLeft > 0) { timeLeft--; await InvokeAsync(StateHasChanged); }
            else await InvokeAsync(() => HandleAnswer(-1));
        };
        timer.Start();
    }

    private async Task HandleAnswer(int index)
    {
        if (showFeedback) return;
        StopTimer();
        showFeedback = true;

        if (index != -1)
        {
            selectedLetter = ((char)('A' + index)).ToString();
            if (selectedLetter == questions[currentIndex].CorrectAnswer) score++;
        }

        StateHasChanged();
        await Task.Delay(2000); 

        showFeedback = false;
        selectedLetter = "";
        currentIndex++;

        if (currentIndex < questions.Count) StartTimer();
        else isFinished = true;

        StateHasChanged();
    }

    private void Restart() => NavManager.NavigateTo($"/quiz/{Language}", true);
    private void StopTimer() { timer?.Stop(); timer?.Dispose(); }
    public void Dispose() => StopTimer();
}